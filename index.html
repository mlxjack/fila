<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Fila de Vendas</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="login-screen" class="screen">
      <div class="login-container">
        <h1>Bem-vinda</h1>
        <p>Digite a senha para acessar o sistema:</p>
        <input type="password" id="password-input" placeholder="Senha" autocomplete="off" />
        <button id="login-button">Entrar</button>
        <div id="login-error" class="error"></div>
      </div>
    </div>

    <div id="app-screen" class="screen hidden">
      <header>
        <h1>Sistema de Fila de Vendas</h1>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span id="loading-indicator" style="font-size: 12px; color: #fff; display: none;">Sincronizando...</span>
            <button id="logout-button" class="logout-button">Sair</button>
        </div>
      </header>
      <main>
        <section class="queue-section" id="whatsapp-queue">
          <h2>Fila WhatsApp</h2>
          <div class="current-turn">
            <span class="label">Vez da vendedora:</span>
            <span id="whatsapp-current" class="current-name">...</span>
          </div>
          <button class="next-button" data-queue="whatsapp">Pular vez (Sem Venda)</button>

          <div class="order-list">
            <h3>Ordem das vendedoras</h3>
            <ul id="whatsapp-order"></ul>
          </div>

          <div class="register-form">
            <h3>Registrar atendimento</h3>
            <form id="whatsapp-form">
              <label>Nome do cliente</label>
              <input type="text" id="cliente-whatsapp" required />

              <label>Contato</label>
              <input type="text" id="contato-whatsapp" required />

              <label>Observação</label>
              <textarea id="observacao-whatsapp" rows="2"></textarea>
              <button type="submit">Registrar Venda & Próximo</button>
            </form>
          </div>

          <div class="history">
            <h3>Últimos atendimentos</h3>
            <tbody id="whatsapp-history"></tbody>
          </div>
        </section>

        <section class="queue-section" id="site-queue">
          <h2>Fila de Clientes do Site</h2>
          <div class="current-turn">
            <span class="label">Vez da vendedora:</span>
            <span id="site-current" class="current-name">...</span>
          </div>
          <button class="next-button" data-queue="site">Pular vez (Sem Venda)</button>

          <div class="order-list">
            <h3>Ordem das vendedoras</h3>
            <ul id="site-order"></ul>
          </div>

          <div class="register-form">
            <h3>Registrar atendimento</h3>
            <form id="site-form">
              <label>Nome do cliente</label>
              <input type="text" id="cliente-site" required />

              <label>Contato</label>
              <input type="text" id="contato-site" required />

              <label>Observação</label>
              <textarea id="observacao-site" rows="2"></textarea>
              <button type="submit">Registrar Venda & Próximo</button>
            </form>
          </div>

          <div class="history">
            <h3>Últimos atendimentos</h3>
            <tbody id="site-history"></tbody>
          </div>
        </section>
      </main>
    </div>

    <script>
      // CONFIGURAÇÃO
      // ---------------------------------------------------------
      // COLOQUE AQUI A NOVA URL DO SEU SCRIPT DO GOOGLE (PASSO 2)
      const SCRIPT_URL = "COLOQUE_SUA_URL_DO_APPS_SCRIPT_AQUI"; 
      // ---------------------------------------------------------

      const vendedoras = ["Dani", "Talita", "Renata"];
      const PASSWORD = "equipedevendas";
      
      // Estado Global (agora vem da planilha)
      let globalState = {
        whatsappIndex: 0,
        siteIndex: 0,
        history: []
      };

      // Elementos DOM
      const els = {
        loginScreen: document.getElementById("login-screen"),
        appScreen: document.getElementById("app-screen"),
        passwordInput: document.getElementById("password-input"),
        loginBtn: document.getElementById("login-button"),
        errorMsg: document.getElementById("login-error"),
        loading: document.getElementById("loading-indicator"),
        queues: {
          whatsapp: {
            current: document.getElementById("whatsapp-current"),
            list: document.getElementById("whatsapp-order"),
            tbody: document.getElementById("whatsapp-history"),
            form: document.getElementById("whatsapp-form")
          },
          site: {
            current: document.getElementById("site-current"),
            list: document.getElementById("site-order"),
            tbody: document.getElementById("site-history"),
            form: document.getElementById("site-form")
          }
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("loggedIn") === "true") showApp();
        else showLogin();

        els.loginBtn.addEventListener("click", handleLogin);
        document.getElementById("logout-button").addEventListener("click", () => {
          localStorage.removeItem("loggedIn");
          location.reload();
        });

        // Botões de Pular (Next)
        document.querySelectorAll(".next-button").forEach(btn => {
          btn.addEventListener("click", () => sendData(btn.dataset.queue, 'next', {}));
        });

        // Formulários
        Object.keys(els.queues).forEach(q => {
          els.queues[q].form.addEventListener("submit", (e) => {
            e.preventDefault();
            const prefix = q === 'whatsapp' ? '-whatsapp' : '-site';
            const data = {
              cliente: document.getElementById(`cliente${prefix}`).value,
              contato: document.getElementById(`contato${prefix}`).value,
              observacao: document.getElementById(`observacao${prefix}`).value
            };
            sendData(q, 'register', data);
            els.queues[q].form.reset();
          });
        });
        
        // Sincronização automática a cada 5 segundos
        setInterval(fetchData, 5000);
      });

      function handleLogin() {
        if (els.passwordInput.value.trim() === PASSWORD) {
          localStorage.setItem("loggedIn", "true");
          showApp();
        } else {
          els.errorMsg.textContent = "Senha incorreta.";
        }
      }

      function showLogin() {
        els.loginScreen.classList.remove("hidden");
        els.appScreen.classList.add("hidden");
      }

      function showApp() {
        els.loginScreen.classList.add("hidden");
        els.appScreen.classList.remove("hidden");
        fetchData(); // Busca dados iniciais
      }

      // Função Principal de Leitura (GET)
      async function fetchData() {
        if (!SCRIPT_URL || SCRIPT_URL.includes("COLOQUE")) return;
        els.loading.style.display = 'block';
        
        try {
          const res = await fetch(SCRIPT_URL);
          const data = await res.json();
          
          // Atualiza estado global
          globalState.whatsappIndex = parseInt(data.state.whatsappIndex);
          globalState.siteIndex = parseInt(data.state.siteIndex);
          globalState.history = data.history;

          updateUI();
        } catch (e) {
          console.error("Erro ao sincronizar:", e);
        } finally {
          els.loading.style.display = 'none';
        }
      }

      // Função Principal de Escrita (POST)
      async function sendData(queueType, action, formData) {
        if (!SCRIPT_URL) return;
        els.loading.style.display = 'block';
        els.loading.textContent = "Salvando...";

        const payload = {
          action: action, // 'register' ou 'next'
          fila: queueType,
          vendedora: getCurrentVendor(queueType),
          dataHora: new Date().toLocaleString('pt-BR'),
          ...formData
        };

        // Otimista: Já atualiza a interface antes de voltar do servidor
        // para parecer instantâneo para quem clicou
        advanceQueueLocally(queueType);

        try {
            // Usamos mode: 'no-cors' para evitar erro, mas isso significa que não lemos a resposta
            // Porém, como temos o "setInterval", os dados serão corrigidos em 5s se houver erro
            await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
            });
            
            // Força uma atualização real após 1 segundo
            setTimeout(fetchData, 1000);

        } catch (e) {
            alert("Erro ao salvar. Verifique sua conexão.");
            fetchData(); // Reverte mudanças locais se falhar
        }
      }

      function getCurrentVendor(queueType) {
        const idx = queueType === 'whatsapp' ? globalState.whatsappIndex : globalState.siteIndex;
        return vendedoras[idx];
      }

      function advanceQueueLocally(queueType) {
         if (queueType === 'whatsapp') {
             globalState.whatsappIndex = (globalState.whatsappIndex + 1) % 3;
         } else {
             globalState.siteIndex = (globalState.siteIndex + 1) % 3;
         }
         updateUI();
      }

      function updateUI() {
        renderQueueSection('whatsapp', globalState.whatsappIndex);
        renderQueueSection('site', globalState.siteIndex);
        renderHistoryTables();
      }

      function renderQueueSection(queue, currentIndex) {
        const qEls = els.queues[queue];
        // Vendedora Atual
        qEls.current.textContent = vendedoras[currentIndex];
        
        // Lista
        qEls.list.innerHTML = '';
        vendedoras.forEach((nome, idx) => {
          const li = document.createElement("li");
          li.textContent = nome;
          if (idx === currentIndex) li.classList.add("current");
          qEls.list.appendChild(li);
        });
      }

      function renderHistoryTables() {
        // Limpa tabelas
        els.queues.whatsapp.tbody.innerHTML = '';
        els.queues.site.tbody.innerHTML = '';

        // Preenche com dados vindos da planilha
        globalState.history.forEach(item => {
            // Verifica se o item pertence à fila (tratamento de string case-insensitive)
            const filaItem = (item.fila || '').toLowerCase();
            
            let targetBody = null;
            if (filaItem === 'whatsapp') targetBody = els.queues.whatsapp.tbody;
            if (filaItem === 'site') targetBody = els.queues.site.tbody;

            if (targetBody) {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${item.datahora}</td>
                    <td>${item.vendedora}</td>
                    <td>${item.cliente}</td>
                    <td>${item.contato}</td>
                    <td>${item.observacao}</td>
                `;
                // Insere no final (append) pois o array já veio invertido do script
                targetBody.appendChild(tr); 
            }
        });
      }
    </script>
  </body>
</html>
