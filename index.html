<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Fila de Vendas</title>
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Ajuste extra para garantir que a tabela apareça bonita */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        background: white;
        border-radius: 4px;
        overflow: hidden;
      }
      th, td {
        padding: 10px;
        text-align: left;
        border-bottom: 1px solid #eee;
        font-size: 14px;
      }
      th {
        background-color: #f4f4f4;
        font-weight: bold;
        color: #555;
      }
      td {
        color: #333;
      }
    </style>
  </head>
  <body>
    <div id="login-screen" class="screen">
      <div class="login-container">
        <h1>Bem-vinda</h1>
        <p>Digite a senha para acessar o sistema:</p>
        <input type="password" id="password-input" placeholder="Senha" autocomplete="off" />
        <button id="login-button">Entrar</button>
        <div id="login-error" class="error"></div>
      </div>
    </div>

    <div id="app-screen" class="screen hidden">
      <header>
        <h1>Sistema de Fila de Vendas</h1>
        <div style="display: flex; align-items: center; gap: 10px;">
            <span id="status-indicator" style="font-size: 12px; color: #ffd700; display: none;">Carregando...</span>
            <button id="logout-button" class="logout-button">Sair</button>
        </div>
      </header>
      <main>
        <section class="queue-section" id="whatsapp-queue">
          <h2>Fila WhatsApp</h2>
          <div class="current-turn">
            <span class="label">Vez da vendedora:</span>
            <span id="whatsapp-current" class="current-name">...</span>
          </div>
          <button class="next-button" data-queue="whatsapp">Pular vez (Sem Venda)</button>

          <div class="order-list">
            <h3>Ordem das vendedoras</h3>
            <ul id="whatsapp-order"></ul>
          </div>

          <div class="register-form">
            <h3>Registrar atendimento</h3>
            <form id="whatsapp-form">
              <label>Nome do cliente</label>
              <input type="text" id="cliente-whatsapp" required />

              <label>Contato</label>
              <input type="text" id="contato-whatsapp" required />

              <label>Observação</label>
              <textarea id="observacao-whatsapp" rows="2"></textarea>
              <button type="submit">Registrar Venda & Próximo</button>
            </form>
          </div>

          <div class="history">
            <h3>Últimos atendimentos</h3>
            <table>
              <thead>
                <tr>
                  <th style="width: 25%">Data</th>
                  <th style="width: 15%">Vend.</th>
                  <th style="width: 20%">Cliente</th>
                  <th style="width: 40%">Obs</th>
                </tr>
              </thead>
              <tbody id="whatsapp-history"></tbody>
            </table>
          </div>
        </section>

        <section class="queue-section" id="site-queue">
          <h2>Fila de Clientes do Site</h2>
          <div class="current-turn">
            <span class="label">Vez da vendedora:</span>
            <span id="site-current" class="current-name">...</span>
          </div>
          <button class="next-button" data-queue="site">Pular vez (Sem Venda)</button>

          <div class="order-list">
            <h3>Ordem das vendedoras</h3>
            <ul id="site-order"></ul>
          </div>

          <div class="register-form">
            <h3>Registrar atendimento</h3>
            <form id="site-form">
              <label>Nome do cliente</label>
              <input type="text" id="cliente-site" required />

              <label>Contato</label>
              <input type="text" id="contato-site" required />

              <label>Observação</label>
              <textarea id="observacao-site" rows="2"></textarea>
              <button type="submit">Registrar Venda & Próximo</button>
            </form>
          </div>

          <div class="history">
            <h3>Últimos atendimentos</h3>
            <table>
              <thead>
                <tr>
                  <th style="width: 25%">Data</th>
                  <th style="width: 15%">Vend.</th>
                  <th style="width: 20%">Cliente</th>
                  <th style="width: 40%">Obs</th>
                </tr>
              </thead>
              <tbody id="site-history"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>

    <script>
      // =========================================================
      // IMPORTANTE: MANTENHA O SEU LINK QUE JÁ ESTÁ FUNCIONANDO
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxbCRpw3P0a113lK0fnVpFmj_WfysRhwhOOwpFTrFZODkBY4Urs7Ykbz8r1YbrRejr3Dg/exec"; 
      // =========================================================

      const vendedoras = ["Dani", "Talita", "Renata"];
      const PASSWORD = "equipedevendas";
      
      let globalState = {
        whatsappIndex: 0,
        siteIndex: 0,
        history: []
      };

      const els = {
        loginScreen: document.getElementById("login-screen"),
        appScreen: document.getElementById("app-screen"),
        passwordInput: document.getElementById("password-input"),
        loginBtn: document.getElementById("login-button"),
        errorMsg: document.getElementById("login-error"),
        status: document.getElementById("status-indicator"),
        queues: {
          whatsapp: {
            current: document.getElementById("whatsapp-current"),
            list: document.getElementById("whatsapp-order"),
            tbody: document.getElementById("whatsapp-history"),
            form: document.getElementById("whatsapp-form")
          },
          site: {
            current: document.getElementById("site-current"),
            list: document.getElementById("site-order"),
            tbody: document.getElementById("site-history"),
            form: document.getElementById("site-form")
          }
        }
      };

      document.addEventListener("DOMContentLoaded", () => {
        if (localStorage.getItem("loggedIn") === "true") showApp();
        else showLogin();

        els.loginBtn.addEventListener("click", handleLogin);
        document.getElementById("logout-button").addEventListener("click", () => {
          localStorage.removeItem("loggedIn");
          location.reload();
        });

        document.querySelectorAll(".next-button").forEach(btn => {
          btn.addEventListener("click", () => sendData(btn.dataset.queue, 'next', {}));
        });

        Object.keys(els.queues).forEach(q => {
          els.queues[q].form.addEventListener("submit", (e) => {
            e.preventDefault();
            const prefix = q === 'whatsapp' ? '-whatsapp' : '-site';
            const data = {
              cliente: document.getElementById(`cliente${prefix}`).value,
              contato: document.getElementById(`contato${prefix}`).value,
              observacao: document.getElementById(`observacao${prefix}`).value
            };
            sendData(q, 'register', data);
            els.queues[q].form.reset();
          });
        });
        
        updateUI();
        setInterval(fetchData, 5000);
      });

      function handleLogin() {
        if (els.passwordInput.value.trim() === PASSWORD) {
          localStorage.setItem("loggedIn", "true");
          showApp();
        } else {
          els.errorMsg.textContent = "Senha incorreta.";
        }
      }

      function showLogin() {
        els.loginScreen.classList.remove("hidden");
        els.appScreen.classList.add("hidden");
      }

      function showApp() {
        els.loginScreen.classList.add("hidden");
        els.appScreen.classList.remove("hidden");
        fetchData(); 
      }

      async function fetchData() {
        if (!SCRIPT_URL) return;
        
        try {
          const res = await fetch(SCRIPT_URL);
          if (!res.ok) throw new Error("Erro na rede");
          
          const data = await res.json();
          
          if(data.result === "Error") {
             console.error("Erro no script:", data.error);
             return;
          }

          globalState.whatsappIndex = parseInt(data.state.whatsappIndex) || 0;
          globalState.siteIndex = parseInt(data.state.siteIndex) || 0;
          globalState.history = data.history || [];
          
          els.status.style.display = 'none';
          updateUI();
        } catch (e) {
          console.error("Erro ao sincronizar:", e);
          els.status.textContent = "Erro de conexão";
          els.status.style.display = 'block';
          els.status.style.color = 'red';
        }
      }

      async function sendData(queueType, action, formData) {
        if (!SCRIPT_URL) return;
        
        els.status.style.display = 'block';
        els.status.style.color = '#fff';
        els.status.textContent = "Salvando...";

        const payload = {
          action: action, 
          fila: queueType,
          vendedora: getCurrentVendor(queueType),
          dataHora: new Date().toLocaleString('pt-BR'),
          ...formData
        };

        advanceQueueLocally(queueType);

        try {
            await fetch(SCRIPT_URL, {
              method: 'POST',
              mode: 'no-cors',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            
            setTimeout(fetchData, 1500); 
            els.status.textContent = "Salvo!";
            setTimeout(() => els.status.style.display = 'none', 2000);

        } catch (e) {
            alert("Erro ao salvar. Verifique se a planilha está acessível.");
            fetchData();
        }
      }

      function getCurrentVendor(queueType) {
        const idx = queueType === 'whatsapp' ? globalState.whatsappIndex : globalState.siteIndex;
        return vendedoras[idx] || vendedoras[0];
      }

      function advanceQueueLocally(queueType) {
         if (queueType === 'whatsapp') {
             globalState.whatsappIndex = (globalState.whatsappIndex + 1) % 3;
         } else {
             globalState.siteIndex = (globalState.siteIndex + 1) % 3;
         }
         updateUI();
      }

      function updateUI() {
        renderQueueSection('whatsapp', globalState.whatsappIndex);
        renderQueueSection('site', globalState.siteIndex);
        renderHistoryTables();
      }

      function renderQueueSection(queue, currentIndex) {
        if (isNaN(currentIndex)) currentIndex = 0;
        const qEls = els.queues[queue];
        
        const nomeVendedora = vendedoras[currentIndex] || vendedoras[0];
        qEls.current.textContent = nomeVendedora;
        
        qEls.list.innerHTML = '';
        vendedoras.forEach((nome, idx) => {
          const li = document.createElement("li");
          li.textContent = nome;
          if (idx === currentIndex) li.classList.add("current");
          qEls.list.appendChild(li);
        });
      }

      function renderHistoryTables() {
        els.queues.whatsapp.tbody.innerHTML = '';
        els.queues.site.tbody.innerHTML = '';

        if (!globalState.history) return;

        globalState.history.forEach(item => {
            const filaItem = (item.fila || '').toLowerCase();
            let targetBody = null;
            if (filaItem === 'whatsapp') targetBody = els.queues.whatsapp.tbody;
            if (filaItem === 'site') targetBody = els.queues.site.tbody;

            if (targetBody) {
                // Formatação simples da data para ficar bonita
                let displayDate = item.datahora;
                try {
                    const d = new Date(item.datahora);
                    if(!isNaN(d)) {
                        displayDate = d.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute:'2-digit' });
                    }
                } catch(e) {}

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${displayDate}</td>
                    <td>${item.vendedora}</td>
                    <td>${item.cliente}</td>
                    <td>${item.observacao}</td>
                `;
                targetBody.appendChild(tr); 
            }
        });
      }
    </script>
  </body>
</html>
